################################################################################
# Dockerfile pour le développement local
# Basé sur Ubuntu 24.04 avec build multi-stage pour optimiser le cache
################################################################################

################################################################################
# Stage 1: Base - Installation des dépendances système et Node.js
# Ce stage est mis en cache et ne sera reconstruit que si les dépendances
# système changent
################################################################################
FROM ubuntu:24.04 AS base

# Arguments de build pour désactiver le proxy
ARG HTTP_PROXY=
ARG HTTPS_PROXY=
ARG http_proxy=
ARG https_proxy=
ARG NO_PROXY=
ARG no_proxy=

# Variables d'environnement pour éviter les prompts interactifs
ENV DEBIAN_FRONTEND=noninteractive \
    NODE_VERSION=22 \
    NODE_ENV=development \
    HOST=0.0.0.0 \
    PORT=1337 \
    HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    http_proxy=${http_proxy} \
    https_proxy=${https_proxy} \
    NO_PROXY=${NO_PROXY} \
    no_proxy=${no_proxy}

# Désactiver le proxy pour apt (pour éviter les erreurs en environnement d'entreprise)
RUN echo 'Acquire::http::Proxy "";' > /etc/apt/apt.conf.d/99-no-proxy && \
    echo 'Acquire::https::Proxy "";' >> /etc/apt/apt.conf.d/99-no-proxy && \
    echo 'Acquire::ftp::Proxy "";' >> /etc/apt/apt.conf.d/99-no-proxy

# Installer les dépendances système de base
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        ca-certificates \
        xz-utils \
        openssl \
        build-essential \
        python3 \
        make \
        g++ \
        git \
        libvips-dev \
        libpng-dev \
        zlib1g-dev \
        autoconf \
        automake \
        nasm \
        wget && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    update-ca-certificates

# Installer Node.js 22.11.0 LTS via les binaires officiels
# Détecter l'architecture automatiquement
RUN NODE_VERSION_FULL="22.11.0" && \
    ARCH=$(uname -m) && \
    case "$ARCH" in \
        x86_64) ARCH="x64" ;; \
        aarch64|arm64) ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    echo "Installing Node.js ${NODE_VERSION_FULL} for architecture: ${ARCH}" && \
    curl --noproxy "*" -fsSL "https://nodejs.org/dist/v${NODE_VERSION_FULL}/node-v${NODE_VERSION_FULL}-linux-${ARCH}.tar.xz" -o /tmp/node.tar.xz && \
    tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1 && \
    rm -f /tmp/node.tar.xz && \
    ln -sf /usr/local/bin/node /usr/bin/node && \
    ln -sf /usr/local/bin/npm /usr/bin/npm

# Vérifier que Node.js et npm sont installés
RUN node --version && npm --version || (echo "Node.js installation failed" && exit 1)

# Créer un utilisateur non-root
RUN groupadd -r appuser && \
    useradd -r -g appuser -u 1001 -d /home/appuser -s /bin/bash appuser && \
    mkdir -p /home/appuser && \
    chown -R appuser:appuser /home/appuser

################################################################################
# Stage 2: Dependencies - Installation des dépendances npm
# Ce stage est mis en cache et ne sera reconstruit que si package.json ou
# package-lock.json changent
################################################################################
FROM base AS dependencies

# Créer les répertoires nécessaires
RUN mkdir -p /opt/app && \
    chown -R appuser:appuser /opt/app

# Définir le répertoire de travail
WORKDIR /opt/app

# Copier uniquement les fichiers de dépendances
COPY package.json package-lock.json* ./

# Désactiver la vérification SSL pour npm (environnements avec proxy d'entreprise)
RUN npm config set strict-ssl false && \
    npm config set registry https://registry.npmjs.org/

# Installer les dépendances
# Cette étape sera mise en cache si package.json et package-lock.json n'ont pas changé
RUN npm install

################################################################################
# Stage 3: Development - Image finale pour le développement
# Ce stage copie les dépendances installées et le code source
# Il sera reconstruit à chaque changement de code source
################################################################################
FROM dependencies AS development

# Copier le reste de l'application
COPY --chown=appuser:appuser . .

# Créer le répertoire pour les uploads
RUN mkdir -p public/uploads && \
    chown -R appuser:appuser public/uploads

# Exposer le port Strapi
EXPOSE 1337

# Passer à l'utilisateur non-root
USER appuser

# Commande de démarrage en mode développement
CMD ["npm", "run", "develop"]
