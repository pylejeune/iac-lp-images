# R√®gles Docker - Optimisation Avanc√©e

## üéØ Optimisation des Builds

### Cache Docker
- Utiliser `--cache-from` pour les builds CI/CD
- Pr√©f√©rer `COPY --chown` au lieu de `RUN chown` s√©par√©
- Utiliser `--mount=type=cache` pour les gestionnaires de paquets

### BuildKit
- **TOUJOURS** activer BuildKit : `DOCKER_BUILDKIT=1`
- Utiliser les features avanc√©es de BuildKit (cache mounts, secrets)
- Pr√©f√©rer `docker buildx` pour les builds multi-plateformes

### Parallel Builds
- Utiliser des builds parall√®les pour les monorepos
- S√©parer les services en Dockerfiles distincts si possible
- Utiliser docker-compose avec `build.parallel: true`

## üìä R√©duction de la Taille

### Multi-Stage Builds
```dockerfile
# Stage 1: D√©pendances uniquement
FROM node:18-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Build
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 3: Runtime minimal
FROM node:18-alpine
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
CMD ["node", "dist/index.js"]
```

### Suppression des Fichiers Inutiles
```dockerfile
# ‚úÖ BON : Supprimer dans la m√™me couche
RUN apt-get update && \
    apt-get install -y package && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# ‚úÖ BON : Nettoyer les caches npm/pip
RUN npm ci --only=production && \
    npm cache clean --force && \
    rm -rf /tmp/*
```

### Images Distroless
- Utiliser `gcr.io/distroless/base` ou `gcr.io/distroless/nodejs` pour la production
- R√©duit drastiquement la surface d'attaque
- N√©cessite des builds statiques

## ‚ö° Performance Runtime

### Variables d'Environnement
- Utiliser `ENV` pour les variables qui changent rarement
- Pr√©f√©rer les secrets Docker pour les donn√©es sensibles
- √âviter les variables d'environnement volumineuses

### Volumes
- Utiliser des volumes nomm√©s pour les donn√©es persistantes
- Pr√©f√©rer `tmpfs` pour les donn√©es temporaires
- √âviter de monter des r√©pertoires entiers si possible

### Networking
- Utiliser des r√©seaux Docker personnalis√©s
- Pr√©f√©rer les noms de services aux IPs
- Utiliser `--network-alias` pour la d√©couverte de services

## üîß Optimisation Docker Compose

### Ressources
```yaml
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

### Health Checks
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### Dependencies
- Utiliser `depends_on` avec conditions de sant√©
- √âviter les d√©pendances circulaires
- Utiliser `restart: unless-stopped` pour la production

## üì¶ Gestion des Images

### Tags S√©mantiques
- Utiliser des tags versionn√©s : `app:v1.2.3`
- Cr√©er des tags `latest` uniquement pour la derni√®re version stable
- Utiliser des tags de commit pour les builds CI/CD

### Image Scanning
- Scanner r√©guli√®rement avec `docker scan`
- Int√©grer dans le pipeline CI/CD
- Utiliser des outils comme Trivy ou Snyk

### Registry
- Utiliser un registry priv√© pour les images internes
- Impl√©menter la r√©tention automatique des images
- Utiliser des tags immutables pour la production

## üöÄ CI/CD Optimization

### Build Cache
```bash
# R√©cup√©rer le cache
docker pull $IMAGE:cache || true
docker build \
  --cache-from $IMAGE:cache \
  --tag $IMAGE:$TAG \
  --tag $IMAGE:cache \
  .
```

### Build Arguments
- Utiliser `ARG` pour les variables de build
- Ne pas exposer de secrets via `ARG`
- Utiliser `--build-arg` avec pr√©caution

### Layer Optimization
- Minimiser le nombre de layers
- Grouper les commandes RUN
- Utiliser `&&` pour cha√Æner les commandes

## üìà Monitoring et M√©triques

### Labels
- Ajouter des labels pour le tracking
```dockerfile
LABEL maintainer="team@example.com"
LABEL version="1.0.0"
LABEL description="Application web"
```

### Logging
- Configurer la rotation des logs
- Utiliser des drivers de logging appropri√©s
- Limiter la taille des logs

## ‚úÖ Checklist d'Optimisation

- [ ] BuildKit activ√©
- [ ] Multi-stage build utilis√©
- [ ] Cache des layers optimis√©
- [ ] Taille de l'image minimale
- [ ] Healthcheck configur√©
- [ ] Utilisateur non-root
- [ ] Secrets g√©r√©s correctement
- [ ] `.dockerignore` complet
- [ ] Tags s√©mantiques utilis√©s
- [ ] Image scann√©e pour vuln√©rabilit√©s
