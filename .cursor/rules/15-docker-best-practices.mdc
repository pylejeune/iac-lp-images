# R√®gles Docker - Bonnes Pratiques et Optimisation

## üê≥ Principes Fondamentaux

### Images Multi-Stage
- **TOUJOURS** utiliser des builds multi-stage pour r√©duire la taille des images finales
- S√©parer les d√©pendances de build des d√©pendances de runtime
- Utiliser des images de base minimales (Alpine, Distroless) pour la production

### Ordre des Instructions
- Placer les instructions qui changent le moins souvent en haut du Dockerfile
- Copier les fichiers de d√©pendances (package.json, requirements.txt) avant le code source
- Installer les d√©pendances avant de copier le code applicatif

### Cache des Layers
- Organiser les instructions pour maximiser l'utilisation du cache Docker
- Grouper les commandes RUN pour r√©duire le nombre de layers
- Utiliser `--mount=type=cache` pour les gestionnaires de paquets

## üì¶ Gestion des D√©pendances

### Installation des Paquets
```dockerfile
# ‚úÖ BON : Utiliser --mount=type=cache pour apt/yum
RUN --mount=type=cache,target=/var/cache/apt \
    apt-get update && apt-get install -y --no-install-recommends \
    package1 package2 && \
    rm -rf /var/lib/apt/lists/*

# ‚úÖ BON : Nettoyer les caches apr√®s installation
RUN npm ci --only=production && npm cache clean --force
```

### Fichiers de D√©pendances
- Copier d'abord les fichiers de d√©pendances (package.json, requirements.txt, etc.)
- Installer les d√©pendances avant de copier le code source
- Utiliser des fichiers .dockerignore pour exclure node_modules, __pycache__, etc.

## üîí S√©curit√©

### Utilisateur Non-Root
- **TOUJOURS** cr√©er et utiliser un utilisateur non-root dans les conteneurs
```dockerfile
# ‚úÖ BON
RUN groupadd -r appuser && useradd -r -g appuser appuser
USER appuser
```

### Secrets et Variables d'Environnement
- **JAMAIS** de secrets en dur dans les Dockerfiles
- Utiliser des secrets Docker ou des variables d'environnement inject√©es au runtime
- Utiliser `.dockerignore` pour exclure les fichiers sensibles

### Images de Base
- Utiliser des images officielles et maintenues
- Pr√©f√©rer des images avec des tags sp√©cifiques (pas `latest`)
- V√©rifier r√©guli√®rement les vuln√©rabilit√©s avec `docker scan`

## ‚ö° Optimisation des Performances

### Taille des Images
- Utiliser des images de base minimales (Alpine Linux, Distroless)
- Supprimer les fichiers inutiles dans la m√™me couche RUN
- √âviter d'installer des outils de d√©veloppement en production

### Build Context
- Utiliser `.dockerignore` pour exclure les fichiers inutiles
- Minimiser le contexte de build (ne pas copier tout le r√©pertoire)
- Utiliser des volumes pour les donn√©es persistantes

### Health Checks
- **TOUJOURS** d√©finir un HEALTHCHECK pour les services critiques
```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1
```

## üìù Structure des Dockerfiles

### Template Recommand√©
```dockerfile
# Stage 1: Build
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 2: Production
FROM node:18-alpine
WORKDIR /app
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --chown=nodejs:nodejs package*.json ./
RUN npm ci --only=production && npm cache clean --force
USER nodejs
EXPOSE 3000
HEALTHCHECK --interval=30s CMD node healthcheck.js
CMD ["node", "server.js"]
```

## üö´ Anti-Patterns √† √âviter

### ‚ùå √Ä NE JAMAIS FAIRE
- Utiliser `apt-get upgrade` (augmente la taille et les vuln√©rabilit√©s)
- Copier tout le r√©pertoire avec `COPY . .` sans `.dockerignore`
- Ex√©cuter en tant que root
- Utiliser `latest` comme tag d'image
- Installer des outils de debug en production
- Exposer tous les ports
- Utiliser `RUN apt-get update` sans nettoyer les caches

## üîç V√©rifications

### Avant de Commiter
- [ ] Image build√©e avec succ√®s
- [ ] Taille de l'image optimis√©e
- [ ] Aucun secret en dur
- [ ] Utilisateur non-root configur√©
- [ ] HEALTHCHECK d√©fini si n√©cessaire
- [ ] `.dockerignore` √† jour
- [ ] Tags d'images sp√©cifiques (pas `latest`)

## üìö R√©f√©rences

- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Dockerfile Best Practices](https://docs.docker.com/develop/dev-best-practices/dockerfile_best-practices/)
- [Security Best Practices](https://docs.docker.com/engine/security/)
